#!/bin/bash
set -e
BASEDIR="$(cd $(dirname $0) && pwd -P)/.."
GENERATOR_PATH="${BASEDIR}/bin/accessions-ttl-generator"

TMPDIR="${BASEDIR}/data/tmp" && mkdir -p ${TMPDIR}
OUTDIR="${BASEDIR}/data/out" && mkdir -p ${OUTDIR}

INPUT_ACCESSIONS_TAB="${1}"
if [[ ! -e ${INPUT_ACCESSIONS_TAB} ]]; then
  cd ${TMPDIR}
  wget "ftp.ncbi.nlm.nih.gov/sra/reports/Metadata/SRA_Accessions.tab"
  INPUT_ACCESSIONS_TAB="${TMPDIR}/SRA_Accessions.tab"
fi

split -l 500000 ${INPUT_ACCESSIONS_TAB} ${TMPDIR}/accessions.
find ${TMPDIR} -name "accessions.*" -type f | while read f; do
  awk -f "${GENERATOR_PATH}" "${f}" > "${OUTDIR}/$(basename ${f}).ttl" &
  [ $( jobs | wc -l ) -ge $( nproc ) ] && wait ||:
done
wait
rm -fr ${TMPDIR}
